<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    body { 
      font-family: 'Lucida Sans Unicode', Trebuchet MS;
      max-width: 900px; 
      margin: 2rem auto; 
      padding: 1rem; 
      line-height: 1.5;
      background-color: rgb(255, 231, 206);
      color: rgb(38, 38, 38);
    }
    .back-link {
      display: inline-block;
      margin-bottom: 10px;
      color: rgb(97, 97, 255);
      text-decoration: none;
      font-size: 1.1em;
    }
    .back-link:hover {
      cursor: help;
      text-decoration: underline;
    }
    header { 
      display:flex; 
      gap:1rem; 
      align-items:center; 
      justify-content:space-between; 
      margin-bottom:1rem; 
    }
    h1 {
      color: rgb(255, 97, 97);
      font-size: 1.8em;
      margin: 0;
    }
    button { 
      padding:0.5rem 1rem; 
      border-radius:6px; 
      border:1px solid rgb(255, 207, 166); 
      background: rgb(255, 241, 216);
      color: rgb(38, 38, 38);
      cursor:pointer;
      font-family: inherit;
    }
    button:hover {
      background: rgb(255, 231, 206);
    }
    textarea { 
      width:100%; 
      min-height:140px; 
      padding:0.75rem; 
      border-radius:6px; 
      border:1px solid rgb(255, 207, 166);
      background: rgb(255, 251, 246);
      color: rgb(38, 38, 38);
      font-family: inherit;
    }
    .profile { display:flex; gap:0.75rem; align-items:center; }
    .profile img { width:40px; height:40px; border-radius:50%; object-fit:cover; }
    pre { 
      background: rgb(255, 251, 246);
      color: rgb(38, 38, 38);
      padding:1rem; 
      border-radius:8px; 
      overflow:auto; 
      white-space:pre-wrap;
      border:1px solid rgb(255, 207, 166);
    }
    .hidden { display:none; }
    footer { margin-top:2rem; color: rgb(97, 97, 97); font-size:0.9rem; }
  </style>
</head>
<body>
  <a href="/" class="back-link">‚Üê Back to Home</a>
  <header>
    <h1>Artificial Intelligence (AI) Frontend by Kutchup</h1>
    <div>
      <button id="login">Log in</button>
      <button id="signup">Sign up</button>
      <button id="logout" class="hidden">Log out</button>
    </div>
  </header>

  <section id="userSection" class="hidden">
    <div class="profile">
      <img id="userPic" src="" alt="avatar"/>
      <div>
        <div id="userName"></div>
        <div id="userEmail" style="color:#666;font-size:0.95rem;"></div>
      </div>
    </div>
  </section>

  <main>
    <p>Type a prompt and send it to the AI:</p>

    <div id="authNotice" style="color:rgb(255, 97, 97); margin-bottom:1rem;"></div>

    <textarea id="prompt" placeholder="Write something to the AI..."></textarea>
    <div style="margin-top:0.75rem; display:flex; gap:0.75rem;">
      <button id="send" disabled>Send to AI</button>
      <button id="clear">Clear</button>
    </div>

    <h3>AI Response</h3>
    <pre id="response">No response yet.</pre>
  </main>

  <footer>
    <small>Using Auth0 for authentication. Vercel for serverless functions. Website by Kutchup.</small>
  </footer>

  <!-- Auth0 SPA SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0.0/auth0-spa-js.production.js"></script>

  <script>
    let auth0 = null;
    let authConfig = null;

    // buttons
    const loginBtn = document.getElementById('login');
    const signupBtn = document.getElementById('signup');
    const logoutBtn = document.getElementById('logout');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');

    const userSection = document.getElementById('userSection');
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const userPicEl = document.getElementById('userPic');
    const authNotice = document.getElementById('authNotice');

    const promptEl = document.getElementById('prompt');
    const responseEl = document.getElementById('response');

    async function fetchConfig() {
      const res = await fetch('/api/config');
      if (!res.ok) {
        throw new Error('Could not fetch config from /api/config. Make sure the API route is configured and AUTH0_DOMAIN + AUTH0_CLIENT_ID are set in Vercel.');
      }
      return res.json();
    }

    async function initAuth() {
      try {
        authConfig = await fetchConfig();
        auth0 = await createAuth0Client({
          domain: authConfig.AUTH0_DOMAIN,
          client_id: authConfig.AUTH0_CLIENT_ID,
          cacheLocation: 'localstorage', // keep sessions across tabs
          useRefreshTokens: true
        });

        // handle redirect after login
        if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
          try {
            await auth0.handleRedirectCallback();
          } finally {
            // remove query params
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        }

        updateUI();
      } catch (err) {
        console.error(err);
        authNotice.textContent = 'Initialization error: ' + err.message;
      }
    }

    async function updateUI() {
      const isAuthenticated = await auth0.isAuthenticated();
      if (isAuthenticated) {
        loginBtn.classList.add('hidden');
        signupBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');

        const user = await auth0.getUser();
        userSection.classList.remove('hidden');
        userNameEl.textContent = user.name || user.nickname || '(no name)';
        userEmailEl.textContent = user.email || '';
        userPicEl.src = user.picture || 'https://www.gravatar.com/avatar/?d=mp';

        authNotice.textContent = '';
        sendBtn.disabled = false;
      } else {
        loginBtn.classList.remove('hidden');
        signupBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');

        userSection.classList.add('hidden');
        userNameEl.textContent = '';
        userEmailEl.textContent = '';
        userPicEl.src = '';

        authNotice.textContent = 'Please log in to send prompts to the AI.';
        sendBtn.disabled = true;
      }
    }

    loginBtn.addEventListener('click', async () => {
      await auth0.loginWithRedirect({
        authorizationParams: {
          redirect_uri: window.location.origin
        }
      });
    });

    signupBtn.addEventListener('click', async () => {
      await auth0.loginWithRedirect({
        authorizationParams: {
          redirect_uri: window.location.origin,
          screen_hint: 'signup'
        }
      });
    });

    logoutBtn.addEventListener('click', async () => {
      auth0.logout({
        logoutParams: {
          returnTo: window.location.origin
        }
      });
    });

    sendBtn.addEventListener('click', async () => {
      const prompt = promptEl.value.trim();
      if (!prompt) {
        alert('Please enter a prompt.');
        return;
      }

      sendBtn.disabled = true;
      responseEl.textContent = 'Sending...';

      try {
        // Get an access token (ID token or other token depending on configuration)
        // This token will be forwarded to the serverless function. The server may verify it if you choose to implement verification.
        const token = await auth0.getTokenSilently();

        const res = await fetch('/api/ai', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ prompt })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || err.message || 'Server error');
        }

        const data = await res.json();
        // The server returns {result: "text..."} (or the raw provider response if you prefer).
        responseEl.textContent = data.result || JSON.stringify(data, null, 2);
      } catch (err) {
        console.error(err);
        responseEl.textContent = 'Error: ' + err.message;
      } finally {
        sendBtn.disabled = false;
      }
    });

    clearBtn.addEventListener('click', () => {
      promptEl.value = '';
      responseEl.textContent = 'No response yet.';
    });

    // initialize on page load
    window.addEventListener('load', initAuth);
  </script>
</body>
</html>